name: CI
on:
  
 push:
  #branches: [ "main" ]
 #pull_request:
  #branches: [ "main" ]
  
 workflow_dispatch:
jobs:
  
 build:
   
  runs-on: ubuntu-latest
  
  steps:
   
   - uses: actions/checkout@v3
   # Runs a set of commands using the runners shell
   - name: Build
     run: |
      chmod +x gradlew 
      ./gradlew build 
      ls -ltr

   - name: SonarCloud Analysis
     run: |
       chmod +x gradlew
       ./gradlew build sonar -Dsonar.token=${{ secrets.SECRET_SONARCLOUD }}
  
   - name: Docker Login
     uses: docker/login-action@v2.2.0
     with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
   
   - name: Copy .jar file to root directory
     run: |
        cp $GITHUB_WORKSPACE/build/libs/*.jar .
        chmod 777 *.jar
        ls -lt

   - name: Docker Build
     run: |
        docker build --tag xamaztian/pet-clinic:latest .
        docker images

   - name: Docker Push
     run: |
        docker push xamaztian/pet-clinic:latest
        docker images
      
 deploy:
  
  runs-on: self-hosted
  needs: build
  steps:
   
   - uses: actions/checkout@v2
   
   - name: Deploy to Minikube
     run: |
       kubectl apply -f deployment.yml